name: ðŸŒ™ Nightly Checks

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  dependency-audit:
    name: ðŸ” Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install Leiningen
        run: |
          wget https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
          chmod +x lein
          sudo mv lein /usr/local/bin/

      - name: Check for outdated dependencies
        working-directory: backend
        run: |
          echo "Checking for outdated Clojure dependencies..."
          lein ancient :all || echo "âš ï¸  Some dependencies are outdated"

      - name: Security audit
        working-directory: backend
        run: |
          echo "Running security audit on dependencies..."
          # Check for known vulnerabilities
          lein deps :tree | grep -i "SECURITY" || echo "No obvious security issues found"

  extended-tests:
    name: ðŸ§ª Extended Test Suite
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Cache Leiningen dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-lein-${{ hashFiles('backend/project.clj') }}
          restore-keys: |
            ${{ runner.os }}-lein-

      - name: Install Leiningen
        run: |
          wget https://raw.githubusercontent.com/technomancy/leiningen/stable/bin/lein
          chmod +x lein
          sudo mv lein /usr/local/bin/
          lein version

      - name: Run all tests with coverage
        working-directory: backend
        run: |
          echo "Running full test suite..."
          lein test

      - name: Performance tests
        working-directory: backend
        run: |
          echo "Running performance tests..."
          # Add performance test commands here if available

  database-migration-test:
    name: ðŸ—„ï¸ Database Migration Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        run: docker build --target production -t aviation-missions:nightly .

      - name: Test fresh database initialization
        run: |
          echo "Testing fresh database initialization..."
          docker run -d --name fresh-db-test \
            -p 8080:3000 \
            -v $(pwd)/test-fresh-db:/app/data \
            aviation-missions:nightly

          echo "Waiting for /health to become ready..."
          for i in {1..30}; do
            if curl -fs http://localhost:8080/health >/dev/null 2>&1; then
              break
            fi
            sleep 2
          done

          curl -fs http://localhost:8080/health | grep '"missions_loaded"' || (docker logs fresh-db-test && exit 1)
          docker rm -f fresh-db-test
          rm -rf test-fresh-db
          echo "âœ… Fresh database initialization successful"

      - name: Test database persistence
        run: |
          echo "Testing database persistence..."
          mkdir -p test-persist-db
          
          # Start container, create data
          docker run -d --name persist-test-1 \
            -p 8080:3000 \
            -v $(pwd)/test-persist-db:/app/data \
            aviation-missions:nightly
          
          sleep 10
          
          # Create a test mission
          curl -X POST http://localhost:8080/api/missions \
            -H "Content-Type: application/json" \
            -d '{"title":"Persistence Test","category":"Training","difficulty":5,"objective":"Test","mission_description":"Test","why_description":"Test"}' || true
          
          docker rm -f persist-test-1
          
          # Start new container with same volume
          docker run -d --name persist-test-2 \
            -p 8080:3000 \
            -v $(pwd)/test-persist-db:/app/data \
            aviation-missions:nightly
          
          sleep 10
          
          # Check data persisted
          MISSION_COUNT=$(curl -s http://localhost:8080/api/missions | grep -o '"missions"' | wc -l)
          
          docker rm -f persist-test-2
          rm -rf test-persist-db
          
          if [ "$MISSION_COUNT" -gt 0 ]; then
            echo "âœ… Database persistence test passed"
          else
            echo "âŒ Database persistence test failed"
            exit 1
          fi

  image-size-tracking:
    name: ðŸ“Š Image Size Tracking
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and analyze image
        run: |
          docker build --target production -t aviation-missions:size-check .
          
          IMAGE_SIZE=$(docker image inspect aviation-missions:size-check --format='{{.Size}}')
          IMAGE_SIZE_MB=$((IMAGE_SIZE / 1024 / 1024))
          
          echo "## ðŸ“Š Image Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Size:** ${IMAGE_SIZE_MB} MB" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Layer analysis
          echo "### Layer Breakdown:" >> $GITHUB_STEP_SUMMARY
          docker history aviation-missions:size-check --format "table {{.Size}}\t{{.CreatedBy}}" --no-trunc | head -20 >> $GITHUB_STEP_SUMMARY
          
          if [ $IMAGE_SIZE_MB -gt 500 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸  **Warning:** Image size exceeds 500MB threshold" >> $GITHUB_STEP_SUMMARY
          fi

  health-monitoring:
    name: ðŸ¥ Health Monitoring
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and run long-running test
        run: |
          docker build --target production -t aviation-missions:health .
          
          docker run -d --name health-monitor \
            -p 8080:3000 \
            aviation-missions:health

          echo "Waiting for /health to become ready..."
          for i in {1..30}; do
            if curl -fs http://localhost:8080/health >/dev/null 2>&1; then
              echo "âœ… Initial health check passed"
              break
            fi
            sleep 2
          done

          curl -fs http://localhost:8080/health >/dev/null 2>&1 || (echo "âŒ App never became healthy" && docker logs health-monitor && docker rm -f health-monitor && exit 1)
          
          echo "Monitoring application health for 5 minutes..."
          
          for i in {1..30}; do
            if ! curl -f http://localhost:8080/health 2>/dev/null; then
              echo "âŒ Health check failed at iteration $i"
              docker logs health-monitor
              docker rm -f health-monitor
              exit 1
            fi
            echo "âœ… Health check $i/30 passed"
            sleep 10
          done
          
          docker rm -f health-monitor
          echo "âœ… Application remained healthy for 5 minutes"

  notification:
    name: ðŸ“¢ Send Notification
    runs-on: ubuntu-latest
    needs: [dependency-audit, extended-tests, database-migration-test, image-size-tracking, health-monitoring]
    if: always()
    steps:
      - name: Check status
        run: |
          echo "## ðŸŒ™ Nightly Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All nightly checks completed at $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the job results above for details." >> $GITHUB_STEP_SUMMARY
