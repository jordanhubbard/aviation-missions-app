name: ðŸš‚ Deploy to Railway

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual triggers

jobs:
  deploy:
    name: ðŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    environment: railway-production
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Skip deployment (RAILWAY_TOKEN not set)
        if: ${{ env.RAILWAY_TOKEN == '' }}
        run: |
          echo "RAILWAY_TOKEN is not configured; skipping Railway deployment."

      - name: Install Railway CLI
        if: ${{ env.RAILWAY_TOKEN != '' }}
        run: |
          npm install -g @railway/cli

      - name: Deploy to Railway
        if: ${{ env.RAILWAY_TOKEN != '' }}
        run: |
          echo "ðŸš‚ Deploying to Railway..."
          railway up --service aviation-missions-app || railway up
          echo "âœ… Deployment triggered successfully!"

      - name: Verify deployment
        if: ${{ env.RAILWAY_TOKEN != '' }}
        run: |
          echo "â³ Waiting for deployment to complete..."
          sleep 30
          
          # Get deployment status
          railway status || echo "Status check completed"
          
          echo "âœ… Deployment verification complete"
          echo ""
          echo "ðŸŒ Your app should be live on Railway!"
          echo "Check your Railway dashboard for the public URL"

      - name: Deployment summary
        run: |
          echo "## ðŸš‚ Railway Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What was deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— View your app on Railway: Check your Railway dashboard" >> $GITHUB_STEP_SUMMARY

